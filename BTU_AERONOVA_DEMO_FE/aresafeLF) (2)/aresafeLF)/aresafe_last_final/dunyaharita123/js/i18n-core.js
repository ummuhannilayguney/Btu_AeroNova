/**
 * i18n Core - Language management and UI translation system
 * Handles language state, base dictionary translations, and DOM updates
 */

class I18nCore {
    constructor() {
        this.currentLanguage = this.getLang();
        this.baseDictionary = this.initBaseDictionary();
        this.mutationObserver = null;
        this.translationQueue = new Set();
        this.processingQueue = false;
        
        console.log(`üåê i18n initialized with language: ${this.currentLanguage}`);
    }

    // Language state management
    getLang() {
        return localStorage.getItem('preferredLanguage') || 'en'; // ƒ∞ngilizce varsayƒ±lan
    }

    setLang(language) {
        if (language !== this.currentLanguage) {
            this.currentLanguage = language;
            localStorage.setItem('preferredLanguage', language);
            console.log(`üåê Language changed to: ${language}`);
        }
    }

    // Base dictionary for fixed UI strings
    initBaseDictionary() {
        return {
            en: {
                // App title and headers
                "app.title": "Global City Explorer",
                "app.subtitle": "Explore cities around the world in 3D",
                
                // Navigation and controls
                "btn.zoom": "Zoom",
                "btn.open": "Open",
                "btn.reset": "Reset View",
                "btn.location": "Go to my Location",
                "btn.close": "Close",
                "btn.clear": "Clear",
                
                // Search
                "search.placeholder": "Search cities...",
                "search.no-results": "No cities found",
                "search.results": "Search Results",
                
                // Loading and status
                "loading.text": "Loading 3D World...",
                "loading.cities": "Loading city data...",
                "loading.countries": "Loading country boundaries...",
                "status.ready": "3D World ready! Use mouse to rotate, wheel to zoom",
                
                // Country panel
                "country.panel.title": "Country Information",
                "country.meta.population": "Population",
                "country.meta.cities": "Cities",
                "country.toggle.points": "Show city points",
                
                // City types
                "city.type.capital": "National Capital",
                "city.type.admin": "Administrative Center", 
                "city.type.major": "Major City",
                "city.type.city": "City",
                
                // Messages
                "msg.location.granted": "Location access granted",
                "msg.location.denied": "Location access denied",
                "msg.location.error": "Could not get your location",
                "msg.globe.ready": "Globe ready for interaction",
                
                // Language selector
                "lang.select": "Language",
                "lang.en": "English",
                "lang.tr": "T√ºrk√ße",
                
                // Authentication
                "auth.login": "Log In",
                "auth.signup": "Sign Up",
                "auth.login.title": " Log In",
                "auth.signup.title": " Sign Up",
                "auth.email": "Email:",
                "auth.password": "Password:",
                "auth.fullname": "Full Name:",
                "auth.confirm.password": "Confirm Password:",
                "auth.verification.code": "Email Verification Code:",
                "auth.enter.email": "Enter your email",
                "auth.enter.password": "Enter your password",
                "auth.enter.fullname": "Enter your full name",
                "auth.create.password": "Create a password",
                "auth.confirm.password.placeholder": "Confirm your password",
                "auth.verification.placeholder": "Enter 6-digit code",
                "auth.send.code": "Send Code",
                "auth.verification.info": "We'll send a verification code to your email",
                "auth.send.verification": "Send Verification Code",
                "auth.complete.signup": "Complete Sign Up",
                "auth.submit.login": "Log In",
                "auth.submit.signup": "Sign Up",
                "auth.passwords.not.match": "Passwords do not match!",
                "auth.fill.all.fields": "Please fill in all fields!",
                "auth.verification.sent": "Verification code sent to",
                "auth.verification.production.note": "(In production, this would be sent via email)",
                "auth.account.created": "Account created successfully!",
                "auth.welcome": "Welcome to Global City Explorer!",
                "auth.invalid.verification": "Invalid verification code!",
                "auth.code.sent": "Code sent to",
                "auth.enter.email.first": "Please enter your email first!",
                "auth.login.attempt": "Login attempt:",
                "auth.login.functionality": "Login functionality will be implemented here!",
                
                // Air Pollution
                "air.pollution": "Air Pollution",
                "air.quality.scale.title": "Air Quality Scale",
                "air.quality.good": "Good",
                "air.quality.moderate": "Good-Moderate",
                "air.quality.unhealthy.sensitive": "Moderate",
                "air.quality.unhealthy": "Moderate-Unhealthy",
                "air.quality.very.unhealthy": "Unhealthy",
                "air.quality.hazardous": "Very Unhealthy",
                "air.mode.enabled": "Air pollution mode ON",
                "air.mode.disabled": "Air pollution mode OFF",
                
                // Turkey Provinces
                "turkey.provinces.enabled": "Turkey provinces enabled",
                "turkey.provinces.disabled": "Turkey provinces disabled",
                "turkey.provinces.loading": "Loading Turkey provinces data...",
                "turkey.provinces.system.ready": "Turkey provinces system ready",
                "turkey.provinces.system.unavailable": "Turkey provinces system not available",
                "turkey.provinces.error.enable": "Error enabling provinces boundaries:",
                "turkey.provinces.error.disable": "Error disabling provinces boundaries:",
                "turkey.provinces.count": "provinces",
                "turkey.provinces.filled.polygons": "filled polygons",
                
                // City Boundaries
                "city.boundaries.enabled": "City boundaries layer enabled",
                "city.boundaries.disabled": "City boundaries layer disabled",
                "city.boundaries.disposed": "City boundaries layer disposed",
                "city.boundaries.system.ready": "City boundaries system ready",
                "city.boundaries.fetching": "Fetching city boundaries for current view...",
                "city.boundaries.loading": "Loading world cities data...",
                "city.boundaries.data.loaded": "cities boundaries data loaded",
                "city.boundaries.loaded": "city boundary loaded",
                "city.boundaries.loaded.success": "city boundaries loaded",
                "city.boundaries.no.data": "No city boundaries found in current view",
                "city.boundaries.error.fetch": "Failed to load city boundaries",
                "city.boundaries.error.load": "Failed to load cities data",
                "city.boundaries.error.enable": "Error enabling city boundaries:",
                "city.boundaries.error.disable": "Error disabling city boundaries:",
                "city.boundaries.init.failed": "City boundaries layer initialization failed",
                "city.boundaries.controller.unavailable": "City boundaries controller not available",
                "city.boundaries.system.unavailable": "City boundaries system not available",
                "city.boundaries.throttled": "Request throttled for bounds:",
                
                // Coordinates
                "coords.lat": "Latitude",
                "coords.lng": "Longitude",
                "coords.alt": "Altitude",
                
                // Country page dynamic content
                "country.info.description": "Administrative divisions and major cities",
                "country.stat.cities": "Cities",
                "country.stat.admin": "Admin Centers",
                "country.stat.population": "Population",
                "population.unknown": "Population unknown",
                "btn.back": "Back to Globe",
                
                // Country page specific
                "country.page.back": "‚Üê Back to Map",
                "country.page.loading": "Loading page...",
                "country.page.search": "Search cities...",
                "country.page.major.cities": "Major Cities",
                "country.page.cities": "Cities",
                "country.page.capital": "Capital",
                "country.page.no.data": "No city data found for this country.",
                
                // State page specific
                "state.page.title": "State Cities",
                "state.page.back": "‚Üê Back to US States",
                "state.page.search": "Search city...",
                "state.page.cities.info": "Cities and Weather Information",
                "state.page.cities.found": "cities found",
                "state.page.cities.showing": "cities showing",
                "state.page.cities.total": "total",
                "state.page.population": "Population",
                "state.page.air.quality": "Air Quality",
                "state.page.no.cities": "No cities found",
                "state.page.try.different": "Try a different search term",
                "state.page.loading": "Loading...",
                "state.page.error.title": "Error loading data",
                "state.page.error.retry": "Try refreshing the page",
                "state.page.error.message": "Data could not be loaded",
                
                // Status messages and logs
                "msg.flying.to": "Flying to",
                "msg.arrived.at": "Arrived at",
                "msg.location.going": "Going to your location...",
                "msg.arrived.location": "Arrived at your location",
                "msg.resetting.view": "Resetting view...",
                "msg.globe.wait": "Globe is still loading, please wait...",
                "msg.world.wait": "3D World is still loading, please wait...",
                "msg.invalid.coordinates": "Invalid coordinates",
                "msg.location.error.move": "Error while moving location",
                "msg.globe.ready": "Globe ready - loading hidden!",
                "msg.your.location": "Your Location",
                "msg.world.ready": "3D World ready! Use mouse to rotate, wheel to zoom",
                "msg.cities.loading": "Loading city data...",
                "msg.cities.loaded": "cities loaded from CSV",
                "msg.csv.failed": "CSV could not be loaded, trying JSON",
                "msg.startup.error": "Startup error",
                "msg.data.load.error": "Data loading error",
                "msg.location.no.support": "Browser does not support location",
                "msg.location.error": "Could not get location",
                "msg.page.created": "Universal page created for",
                "msg.with.places": "with",
                "msg.places": "places",
                "msg.no.cities": "No cities found for this country.",
                "msg.iso.code": "ISO Code",
                "msg.borders.drawn": "All world country borders drawn (NASA style)",
                "msg.creating.page": "Creating dynamic page for"
            },
            tr: {
                // Uygulama ba≈ülƒ±ƒüƒ± ve ba≈ülƒ±klar
                "app.title": "K√ºresel ≈ûehir Gezgini",
                "app.subtitle": "D√ºnya ≈üehirlerini 3D olarak ke≈üfedin",
                
                // Navigasyon ve kontroller
                "btn.zoom": "Yakƒ±nla≈ütƒ±r",
                "btn.open": "A√ß",
                "btn.reset": "G√∂r√ºn√ºm√º Sƒ±fƒ±rla",
                "btn.location": "Konumuma git",
                "btn.close": "Kapat",
                "btn.clear": "Temizle",
                
                // Arama
                "search.placeholder": "≈ûehir ara...",
                "search.no-results": "≈ûehir bulunamadƒ±",
                "search.results": "Arama Sonu√ßlarƒ±",
                
                // Y√ºkleme ve durum
                "loading.text": "3D D√ºnya Y√ºkleniyor...",
                "loading.cities": "≈ûehir verileri y√ºkleniyor...",
                "loading.countries": "√úlke sƒ±nƒ±rlarƒ± y√ºkleniyor...",
                "status.ready": "3D D√ºnya hazƒ±r! Mouse ile d√∂nd√ºr√ºn, tekerlek ile yakƒ±nla≈ütƒ±rƒ±n",
                
                // √úlke paneli
                "country.panel.title": "√úlke Bilgileri",
                "country.meta.population": "N√ºfus",
                "country.meta.cities": "≈ûehirler",
                "country.toggle.points": "≈ûehir noktalarƒ±nƒ± g√∂ster",
                
                // ≈ûehir t√ºrleri
                "city.type.capital": "Ba≈ükent",
                "city.type.admin": "ƒ∞dari Merkez",
                "city.type.major": "B√ºy√ºk ≈ûehir", 
                "city.type.city": "≈ûehir",
                
                // Mesajlar
                "msg.location.granted": "Konum eri≈üimi izni verildi",
                "msg.location.denied": "Konum eri≈üimi reddedildi",
                "msg.location.error": "Konumunuz alƒ±namadƒ±",
                "msg.globe.ready": "K√ºre etkile≈üim i√ßin hazƒ±r",
                "msg.your.location": "Konumunuz",
                
                // Dil se√ßici
                "lang.select": "Dil",
                "lang.en": "English",
                "lang.tr": "T√ºrk√ße",
                
                // Kimlik Doƒürulama
                "auth.login": "Giri≈ü Yap",
                "auth.signup": "Kayƒ±t Ol",
                "auth.login.title": " Giri≈ü Yap",
                "auth.signup.title": " Kayƒ±t Ol",
                "auth.email": "E-posta:",
                "auth.password": "≈ûifre:",
                "auth.fullname": "Ad Soyad:",
                "auth.confirm.password": "≈ûifre Tekrar:",
                "auth.verification.code": "E-posta Doƒürulama Kodu:",
                "auth.enter.email": "E-posta adresinizi girin",
                "auth.enter.password": "≈ûifrenizi girin",
                "auth.enter.fullname": "Ad ve soyadƒ±nƒ±zƒ± girin",
                "auth.create.password": "Bir ≈üifre olu≈üturun",
                "auth.confirm.password.placeholder": "≈ûifrenizi tekrar girin",
                "auth.verification.placeholder": "6 haneli kodu girin",
                "auth.send.code": "Kod G√∂nder",
                "auth.verification.info": "E-posta adresinize doƒürulama kodu g√∂ndereceƒüiz",
                "auth.send.verification": "Doƒürulama Kodu G√∂nder",
                "auth.complete.signup": "Kayƒ±t Ol",
                "auth.submit.login": "Giri≈ü Yap",
                "auth.submit.signup": "Kayƒ±t Ol",
                "auth.passwords.not.match": "≈ûifreler e≈üle≈ümiyor!",
                "auth.fill.all.fields": "L√ºtfen t√ºm alanlarƒ± doldurun!",
                "auth.verification.sent": "Doƒürulama kodu g√∂nderildi:",
                "auth.verification.production.note": "(Ger√ßek uygulamada bu e-posta ile g√∂nderilecek)",
                "auth.account.created": "Hesap ba≈üarƒ±yla olu≈üturuldu!",
                "auth.welcome": "K√ºresel ≈ûehir Gezgini'ne ho≈ü geldiniz!",
                "auth.invalid.verification": "Ge√ßersiz doƒürulama kodu!",
                "auth.code.sent": "Kod g√∂nderildi:",
                "auth.enter.email.first": "L√ºtfen √∂nce e-posta adresinizi girin!",
                "auth.login.attempt": "Giri≈ü denemesi:",
                "auth.login.functionality": "Giri≈ü fonksiyonu burada uygulanacak!",
                
                // Hava Kirliliƒüi
                "air.pollution": "Hava Kirliliƒüi",
                "air.quality.scale.title": "Hava Kalitesi √ñl√ßeƒüi",
                "air.quality.good": "ƒ∞yi",
                "air.quality.moderate": "ƒ∞yi-Orta",
                "air.quality.unhealthy.sensitive": "Orta",
                "air.quality.unhealthy": "Orta-K√∂t√º",
                "air.quality.very.unhealthy": "K√∂t√º",
                "air.quality.hazardous": "√áok K√∂t√º",
                "air.mode.enabled": "Hava kirliliƒüi modu A√áIK",
                "air.mode.disabled": "Hava kirliliƒüi modu KAPALI",
                
                // T√ºrkiye ƒ∞lleri
                "turkey.provinces.enabled": "T√ºrkiye illeri etkinle≈ütirildi",
                "turkey.provinces.disabled": "T√ºrkiye illeri kapatƒ±ldƒ±", 
                "turkey.provinces.loading": "T√ºrkiye illeri verileri y√ºkleniyor...",
                "turkey.provinces.system.ready": "T√ºrkiye illeri sistemi hazƒ±r",
                "turkey.provinces.system.unavailable": "T√ºrkiye illeri sistemi mevcut deƒüil",
                "turkey.provinces.error.enable": "ƒ∞l sƒ±nƒ±rlarƒ±nƒ± etkinle≈ütirme hatasƒ±:",
                "turkey.provinces.error.disable": "ƒ∞l sƒ±nƒ±rlarƒ±nƒ± kapatma hatasƒ±:",
                "turkey.provinces.count": "il",
                "turkey.provinces.filled.polygons": "dolu poligonlar",
                
                // ≈ûehir Sƒ±nƒ±rlarƒ± - City Boundaries
                "city.boundaries.enabled": "≈ûehir sƒ±nƒ±rlarƒ± katmanƒ± etkinle≈ütirildi",
                "city.boundaries.disabled": "≈ûehir sƒ±nƒ±rlarƒ± katmanƒ± devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±",
                "city.boundaries.disposed": "≈ûehir sƒ±nƒ±rlarƒ± katmanƒ± temizlendi",
                "city.boundaries.system.ready": "≈ûehir sƒ±nƒ±rlarƒ± sistemi hazƒ±r",
                "city.boundaries.fetching": "Mevcut g√∂r√ºn√ºm i√ßin ≈üehir sƒ±nƒ±rlarƒ± getiriliyor...",
                "city.boundaries.loading": "D√ºnya ≈üehirleri verisi y√ºkleniyor...",
                "city.boundaries.data.loaded": "≈üehir sƒ±nƒ±rlarƒ± verisi y√ºklendi",
                "city.boundaries.loaded": "≈üehir sƒ±nƒ±rƒ± y√ºklendi",
                "city.boundaries.loaded.success": "≈üehir sƒ±nƒ±rlarƒ± y√ºklendi",
                "city.boundaries.no.data": "Mevcut g√∂r√ºn√ºmde ≈üehir sƒ±nƒ±rƒ± bulunamadƒ±",
                "city.boundaries.error.fetch": "≈ûehir sƒ±nƒ±rlarƒ± y√ºklenemedi",
                "city.boundaries.error.load": "≈ûehir verileri y√ºklenemedi",
                "city.boundaries.error.enable": "≈ûehir sƒ±nƒ±rlarƒ± etkinle≈ütirilemedi:",
                "city.boundaries.error.disable": "≈ûehir sƒ±nƒ±rlarƒ± devre dƒ±≈üƒ± bƒ±rakƒ±lamadƒ±:",
                "city.boundaries.init.failed": "≈ûehir sƒ±nƒ±rlarƒ± katmanƒ± ba≈ülatƒ±lamadƒ±",
                "city.boundaries.controller.unavailable": "≈ûehir sƒ±nƒ±rlarƒ± kontrol√∂r√º mevcut deƒüil",
                "city.boundaries.system.unavailable": "≈ûehir sƒ±nƒ±rlarƒ± sistemi mevcut deƒüil",
                "city.boundaries.throttled": "ƒ∞stek kƒ±sƒ±tlandƒ±:",
                
                // Koordinatlar
                "coords.lat": "Enlem",
                "coords.lng": "Boylam", 
                "coords.alt": "Y√ºkseklik",
                
                // √úlke sayfasƒ± dinamik i√ßerik
                "country.info.description": "ƒ∞dari b√∂l√ºmler ve b√ºy√ºk ≈üehirler",
                "country.stat.cities": "≈ûehirler",
                "country.stat.admin": "ƒ∞dari Merkezler",
                "country.stat.population": "N√ºfus",
                "population.unknown": "N√ºfus bilinmiyor",
                "btn.back": "K√ºreye D√∂n",
                
                // √úlke sayfasƒ± √∂zel
                "country.page.back": "‚Üê Haritaya D√∂n",
                "country.page.loading": "Sayfa y√ºkleniyor...",
                "country.page.search": "≈ûehir ara...",
                "country.page.major.cities": "B√ºy√ºk ≈ûehirler",
                "country.page.cities": "≈ûehirleri",
                "country.page.capital": "Ba≈ükent",
                "country.page.no.data": "Bu √ºlke i√ßin ≈üehir verisi bulunamadƒ±.",
                
                // Eyalet sayfasƒ± √∂zel
                "state.page.title": "Eyalet ≈ûehirleri",
                "state.page.back": "‚Üê Amerika Birle≈üik Devletleri'ne D√∂n",
                "state.page.search": "≈ûehir ara...",
                "state.page.cities.info": "≈ûehirler ve Hava Kalitesi Bilgileri",
                "state.page.cities.found": "≈üehir bulundu",
                "state.page.cities.showing": "≈üehir g√∂steriliyor",
                "state.page.cities.total": "toplam",
                "state.page.population": "N√ºfus",
                "state.page.air.quality": "Hava Kalitesi",
                "state.page.no.cities": "≈ûehir bulunamadƒ±",
                "state.page.try.different": "Farklƒ± bir arama terimi deneyin",
                "state.page.loading": "Y√ºkleniyor...",
                "state.page.error.title": "Veri y√ºklenirken hata olu≈ütu",
                "state.page.error.retry": "Sayfayƒ± yenilemeyi deneyin",
                "state.page.error.message": "Veri y√ºklenemedi",
                
                // Durum mesajlarƒ± ve log'lar
                "msg.flying.to": "konumuna gidiliyor",
                "msg.arrived.at": "konumuna ula≈üƒ±ldƒ±",
                "msg.location.going": "Konumunuza gidiliyor...",
                "msg.arrived.location": "Konumunuza ula≈üƒ±ldƒ±",
                "msg.resetting.view": "G√∂r√ºn√ºm sƒ±fƒ±rlanƒ±yor...",
                "msg.globe.wait": "K√ºre hen√ºz hazƒ±r deƒüil, l√ºtfen bekleyin...",
                "msg.world.wait": "3D D√ºnya hen√ºz y√ºkleniyor, l√ºtfen bekleyin...",
                "msg.invalid.coordinates": "Ge√ßersiz koordinatlar",
                "msg.location.error.move": "Konum deƒüi≈üimi sƒ±rasƒ±nda hata",
                "msg.globe.ready": "K√ºre hazƒ±r - y√ºkleme gizlendi!",
                "msg.world.ready": "3D D√ºnya hazƒ±r! Mouse ile d√∂nd√ºr√ºn, tekerlek ile yakƒ±nla≈ütƒ±rƒ±n",
                "msg.cities.loading": "≈ûehir verileri y√ºkleniyor...",
                "msg.cities.loaded": "≈üehir y√ºklendi",
                "msg.csv.failed": "CSV y√ºklenemedi, JSON deneniyor",
                "msg.startup.error": "Ba≈ülatma hatasƒ±",
                "msg.data.load.error": "Veri y√ºkleme hatasƒ±",
                "msg.location.no.support": "Tarayƒ±cƒ± konum desteƒüi yok",
                "msg.location.error": "Konum alƒ±namadƒ±",
                "msg.page.created": "i√ßin sayfa olu≈üturuldu",
                "msg.with.places": "",
                "msg.places": "yer ile",
                "msg.no.cities": "Bu √ºlke i√ßin ≈üehir bulunamadƒ±.",
                "msg.iso.code": "ISO Kodu",
                "msg.borders.drawn": "T√ºm d√ºnya √ºlke sƒ±nƒ±rlarƒ± √ßizildi (NASA stili)",
                "msg.creating.page": "i√ßin dinamik sayfa olu≈üturuluyor"
            }
        };
    }

    // Get translation from base dictionary
    t(key, fallback = null) {
        const translation = this.baseDictionary[this.currentLanguage]?.[key] 
                         || this.baseDictionary['en']?.[key] 
                         || fallback 
                         || key;
        
        return translation;
    }

    // Apply translations to DOM elements with data-i18n attributes
    applyTranslations() {
        console.log(`üîÑ Applying translations for language: ${this.currentLanguage}`);
        console.log('üìù Available translations:', Object.keys(this.baseDictionary[this.currentLanguage] || {}));
        
        // Update elements with data-i18n attribute
        const elementsWithI18n = document.querySelectorAll('[data-i18n]');
        console.log(`üéØ Found ${elementsWithI18n.length} elements with data-i18n`);
        
        elementsWithI18n.forEach(element => {
            const key = element.getAttribute('data-i18n');
            const translation = this.t(key);
            
            console.log(`üîÑ Translating "${key}" to "${translation}" for element:`, element.tagName);
            
            if (translation && translation !== key) {
                if (element.tagName.toLowerCase() === 'title') {
                    element.textContent = translation;
                } else {
                    element.textContent = translation;
                }
            }
        });
        
        // Update elements with data-i18n-placeholder attribute
        document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
            const key = element.getAttribute('data-i18n-placeholder');
            const translation = this.t(key);
            
            if (translation && translation !== key) {
                element.placeholder = translation;
            }
        });
        
        // Update language selector value
        const langSelect = document.getElementById('langSelect');
        if (langSelect) {
            langSelect.value = this.currentLanguage;
        }
        
        console.log('‚úÖ Base translations applied to DOM');
    }

    // Automatic translation of visible text nodes - DEVRE DI≈ûI
    async autoTranslateVisibleText() {
        // Auto-translation devre dƒ±≈üƒ± - sadece base dictionary kullanƒ±yoruz
        console.log('üåê Auto-translation disabled - using base dictionary only');
        return;
    }

    // Get all visible text nodes
    getVisibleTextNodes() {
        const textNodes = [];
        const walker = document.createTreeWalker(
            document.body,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: (node) => {
                    // Skip if parent has data-i18n-skip attribute
                    if (node.parentElement?.hasAttribute('data-i18n-skip')) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    
                    // Skip if parent is script, style, or other non-visible elements
                    const parent = node.parentElement;
                    if (!parent || ['SCRIPT', 'STYLE', 'NOSCRIPT'].includes(parent.tagName)) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    
                    // Skip if text is whitespace only
                    if (!node.textContent.trim()) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    
                    // Check if element is visible
                    const style = window.getComputedStyle(parent);
                    if (style.display === 'none' || style.visibility === 'hidden') {
                        return NodeFilter.FILTER_REJECT;
                    }
                    
                    return NodeFilter.FILTER_ACCEPT;
                }
            }
        );
        
        let node;
        while (node = walker.nextNode()) {
            textNodes.push(node);
        }
        
        return textNodes;
    }

    // Check if text should be translated
    shouldTranslateText(text) {
        // Skip very short texts
        if (text.length < 3) return false;
        
        // Skip numbers, coordinates, URLs, emails
        if (/^[\d\s.,¬∞-]+$/.test(text)) return false;
        if (/^https?:\/\//.test(text)) return false;
        if (/\S+@\S+\.\S+/.test(text)) return false;
        
        // Skip texts that look like coordinates
        if (/^\d+\.?\d*[¬∞]?\s*[NSEW]?\s*,?\s*\d+\.?\d*[¬∞]?\s*[NSEW]?$/.test(text)) return false;
        
        // Skip single words that are likely proper nouns (start with capital)
        if (text.split(' ').length === 1 && /^[A-Z]/.test(text)) return false;
        
        // Skip if text is already in Turkish (contains Turkish-specific characters)
        if (this.currentLanguage === 'tr' && /[√ßƒüƒ±√∂≈ü√º√áƒûI√ñ≈û√ú]/.test(text)) return false;
        
        // Skip if text looks like it's already Turkish (common Turkish words)
        const turkishWords = ['≈üehir', '√ºlke', 'n√ºfus', 'konum', 'yakƒ±nla≈ütƒ±r', 'sƒ±fƒ±rla', 'arama', 'sonu√ß', 'y√ºkleniyor', 'd√ºnya', 'bilgi', 'g√∂ster', 'kapat', 'temizle'];
        const lowerText = text.toLowerCase();
        if (turkishWords.some(word => lowerText.includes(word))) return false;
        
        // Skip if it's clearly English UI that's already handled by base dictionary
        const englishUIWords = ['reset', 'view', 'zoom', 'search', 'loading', 'city', 'country', 'population', 'close'];
        if (englishUIWords.some(word => lowerText.includes(word))) return false;
        
        return true;
    }

    // Setup mutation observer for dynamic content
    setupMutationObserver() {
        if (this.mutationObserver) {
            this.mutationObserver.disconnect();
        }
        
        this.mutationObserver = new MutationObserver((mutations) => {
            let hasNewText = false;
            
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE || node.nodeType === Node.ELEMENT_NODE) {
                            hasNewText = true;
                        }
                    });
                }
            });
            
            if (hasNewText && this.currentLanguage !== 'en') {
                // Debounce auto-translation for dynamic content
                this.queueAutoTranslation();
            }
        });
        
        this.mutationObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        console.log('üëÄ Mutation observer setup for dynamic content translation');
    }

    // Queue auto-translation to avoid excessive API calls
    queueAutoTranslation() {
        if (this.processingQueue) return;
        
        setTimeout(async () => {
            if (this.processingQueue) return;
            this.processingQueue = true;
            
            try {
                await this.autoTranslateVisibleText();
            } catch (error) {
                console.warn('‚ö†Ô∏è Queued auto-translation failed:', error);
            } finally {
                this.processingQueue = false;
            }
        }, 500); // 500ms debounce
    }

    // Initialize i18n system
    async initialize() {
        console.log('üöÄ Initializing i18n system...');
        console.log(`üåê Current language: ${this.currentLanguage}`);
        console.log(`üìö Available languages:`, Object.keys(this.baseDictionary));
        
        // Apply base translations
        this.applyTranslations();
        
        // Setup language selector
        this.setupLanguageSelector();
        
        console.log('‚úÖ i18n system initialized - base translations only');
        console.log(`üìç Final language setting: ${this.currentLanguage}`);
    }

    // Setup language selector
    setupLanguageSelector() {
        const langSelect = document.getElementById('langSelect');
        if (!langSelect) {
            console.warn('‚ö†Ô∏è Language selector not found');
            return;
        }
        
        // Ba≈ülangƒ±√ß dilini ayarla
        langSelect.value = this.currentLanguage;
        console.log(`üåê Language selector set to: ${this.currentLanguage}`);
        
        langSelect.addEventListener('change', async (e) => {
            const newLanguage = e.target.value;
            console.log(`üåê Language selector changed to: ${newLanguage}`);
            console.log(`üîÑ Old language was: ${this.currentLanguage}`);
            
            const oldLanguage = this.currentLanguage;
            this.setLang(newLanguage);
            
            console.log(`‚úÖ Language updated to: ${this.currentLanguage}`);
            
            // Apply base translations
            console.log('üîÑ Applying base translations...');
            this.applyTranslations();
            
            // Globe'da dil deƒüi≈üikliƒüini bildir
            if (window.globeExplorer && typeof window.globeExplorer.changeLanguage === 'function') {
                console.log('üåç Notifying globe about language change');
                window.globeExplorer.changeLanguage(newLanguage);
            }
            
            console.log('‚úÖ Language change completed');
        });
        
        console.log('‚úÖ Language selector setup completed');
    }

    // Cleanup
    destroy() {
        if (this.mutationObserver) {
            this.mutationObserver.disconnect();
        }
    }
}

// Global instance
window.i18n = new I18nCore();

// Helper function for easy access
window.t = (key, fallback) => window.i18n.t(key, fallback);